#PBS -P zk16
#PBS -q normalbw
#PBS -l walltime=06:00:00,mem=192GB
#PBS -l ncpus=16
#PBS -l storage=gdata/zk16+scratch/zk16
#PBS -l wd
#PBS -N aspen_celltype_F1

set -euo pipefail

module purge
module load gcc/14.2.0
module load R/4.4.2

cd /g/data/zk16/muqing/repos/ASPEN-GLM

export OMP_NUM_THREADS=16
export MKL_NUM_THREADS=16
export OPENBLAS_NUM_THREADS=1
export BB_VAR_PERMUTATIONS=100
export BB_VAR_CORES=16

echo "[`date`] Running ASPEN celltype pipeline (F1 SCE)…"
Rscript scripts/run_aspen_sex_celltype_pipeline_wo_condition_all_cell.R \
  /g/data/zk16/muqing/Projects/Multiome/QC/GEX/allelic_VP/aspensce_F1_filtered.rds \
  results/celltype_wo_condition \
  20000 0 5 0 5 5 10

export OVERWRITE_RESULTS=1
RESULT_ROOT="results/celltype_wo_condition_allcells"
AGEING_SETS_DIR="${RESULT_ROOT}/ageing_sets"
AGEING_VAR_SETS_DIR="${RESULT_ROOT}/ageing_sets_var"
echo "[`date`] GO term enrichments (mean effects)…"
Rscript scripts/GO_term/run_go_enrichment_all_celltypes.R \
  "$RESULT_ROOT" \
  results/GO_term_celltype_allcells
Rscript scripts/GO_term/run_go_enrichment_ageing_sets.R \
  "$RESULT_ROOT" \
  "$AGEING_SETS_DIR" \
  results/GO_term_ageing_sets_allcells \
  results/GO_term_celltype_shared_allcells \
  results/GO_term_celltype_condition_specific_allcells
Rscript scripts/GO_term/run_go_enrichment_var_changes.R \
  "$RESULT_ROOT" \
  results/GO_term_var_changes_allcells
Rscript scripts/GO_term/run_go_enrichment_var_ageing_sets.R \
  "$RESULT_ROOT" \
  "$AGEING_VAR_SETS_DIR" \
  results/GO_term_var_ageing_sets_allcells \
  results/GO_term_var_celltype_shared_allcells \
  results/GO_term_var_celltype_condition_specific_allcells

echo "[`date`] GSEA enrichments…"
Rscript scripts/GSEA/run_gsea_go_all_celltypes.R \
  "$RESULT_ROOT" \
  results/GSEA_celltype_allcells
Rscript scripts/GSEA/run_gsea_go_ageing_sets.R \
  "$RESULT_ROOT" \
  "$AGEING_SETS_DIR" \
  results/GSEA_ageing_sets_allcells \
  results/GSEA_celltype_shared_allcells \
  results/GSEA_celltype_condition_specific_allcells
Rscript scripts/GSEA/run_gsea_var_changes.R \
  "$RESULT_ROOT" \
  results/GSEA_var_changes_allcells
Rscript scripts/GSEA/run_gsea_var_ageing_sets.R \
  "$RESULT_ROOT" \
  "$AGEING_VAR_SETS_DIR" \
  results/GSEA_var_ageing_sets_allcells \
  results/GSEA_var_celltype_shared_allcells \
  results/GSEA_var_celltype_condition_specific_allcells

echo "[`date`] Completed ASPEN celltype pipeline."
